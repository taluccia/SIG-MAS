---
title: "Treatment Math"
author: "Anna Talucci"
date: "6/3/2023"
output: html_document
---


# Packages
```{r}
library(tidyverse)
library(sf)
library(viridis)
```

# Data
## Tx area
```{r}
sn = read.csv("../data/TxArea/snHucTreat10WuiBpPrctRk_2023-06-04.csv")
nc = read.csv("../data/TxArea/ncHucTreat10WuiBpPrctRk_2023-06-04.csv")
cc = read.csv("../data/TxArea/ccHucTreat10WuiBpPrctRk_2023-06-04.csv")
sc = read.csv("../data/TxArea/scHucTreat10WuiBpPrctRk_2023-06-04.csv")
```

## RFFC
RFFC_Priorities_Top.shp
```{r}
rffc = st_read("../data/PriorityRffc/RFFC_Priorities_Top.shp", "RFFC_Priorities_Top")
```

## Hucs
```{r}
huc = st_read("../data/TxHucs/allHucsPrctRankWIP.shp", "allHucsPrctRankWIP")
```

# rffc data
```{r}
( rffc1 = rffc %>% 
  st_set_geometry(NULL) %>% 
  dplyr::select(HUC12, Priority) %>%
    rename(huc12=HUC12)
)
```


# Bind csv
```{r}
( txarea = bind_rows(cc, nc, sc, sn) %>%
    dplyr::select(huc12, TxArea))
```

# Join TxArea to Hucs
```{r}
( hucTxArea = merge(x = huc, y = txarea, by = "huc12", all = TRUE) )
```

```{r}
( hucTxArea1 = merge(x = hucTxArea, y = rffc1, by = "huc12", all = TRUE) )
```


# Plot
```{r}
ggplot(huc, aes(group="RRK_Region")) +
  geom_sf(aes(color = RRK_Region)) 
```

```{r}
huc
```
2878 Hucs across 4 RRK regions
```{r}
huc1 = huc[is.na(huc$RRK_Region),]
```
```{r}
huc1
```
41 HUCs with NAs
```{r eval=FALSE, include=FALSE}
st_write(huc1, "../outputs/HUCsWithNa41.shp", driver="ESRI Shapefile")
```
```{r}
huc2 = huc %>% st_drop_geometry()
  huc2[is.na(huc2$RRK_Region),]
```

# Total Hucs per RRK
```{r}
huc %>% group_by(RRK_Region) %>% 
  summarise(n = n())
```




# Add Percentile group
## WUI

### Sierra Nevada WUI

```{r}
hucTxArea1 %>% 
    filter(RRK_Region=="Sierra Nevada Region")
```

```{r}
( snWui25 = hucTxArea1 %>% 
    filter(RRK_Region=="Sierra Nevada Region") %>%
    filter(WuiPrct <=25) %>%
    mutate(TxWuiPrctl=25) %>%
    mutate(TxHucNos=287)
  )
```
(x>=3&x<=7)
```{r}
( snWui50 = hucTxArea1 %>% 
    filter(RRK_Region=="Sierra Nevada Region") %>%
    filter(WuiPrct >25& WuiPrct <=50) %>%
    mutate(TxWuiPrctl=50) %>%
    mutate(TxHucNos=287)
  )
```

```{r}
( snWui75 = hucTxArea1 %>% 
    filter(RRK_Region=="Sierra Nevada Region") %>%
    filter(WuiPrct >50& WuiPrct <=75) %>%
    mutate(TxWuiPrctl=75) %>%
    mutate(TxHucNos=287)
  )
```

```{r}
( snWui100 = hucTxArea1 %>% 
    filter(RRK_Region=="Sierra Nevada Region") %>%
    filter(WuiPrct >75) %>%
    mutate(TxWuiPrctl=100) %>%
    mutate(TxHucNos=287)
   )
```

### North Coast WUI
```{r}
hucTxArea1 %>% 
    filter(RRK_Region=="North Coast Region")
```

```{r}
( ncWui25 = hucTxArea1 %>% 
    filter(RRK_Region=="North Coast Region") %>%
    filter(WuiPrct <=25) %>%
    mutate(TxWuiPrctl=25) %>%
    mutate(TxHucNos=193)
  )
```
(x>=3&x<=7)
```{r}
( ncWui50 = hucTxArea1 %>% 
    filter(RRK_Region=="North Coast Region") %>%
    filter(WuiPrct >25& WuiPrct <=50) %>%
    mutate(TxWuiPrctl=50) %>%
    mutate(TxHucNos=194)
  )
```

```{r}
( ncWui75 = hucTxArea1 %>% 
    filter(RRK_Region=="North Coast Region") %>%
    filter(WuiPrct >50& WuiPrct <=75) %>%
    mutate(TxWuiPrctl=75) %>%
    mutate(TxHucNos=193)
  )
```

```{r}
( ncWui100 = hucTxArea1 %>% 
    filter(RRK_Region=="North Coast Region") %>%
    filter(WuiPrct >75) %>%
    mutate(TxWuiPrctl=100) %>%
    mutate(TxHucNos=194)
  )
```

## Central Coast WUI
```{r}
hucTxArea1 %>% 
    filter(RRK_Region=="Central Coast Region")
```

```{r}
( ccWui25 = hucTxArea1 %>% 
    filter(RRK_Region=="Central Coast Region") %>%
    filter(WuiPrct <=25) %>%
    mutate(TxWuiPrctl=25) %>%
    mutate(TxHucNos=108)
  )
```
(x>=3&x<=7)
```{r}
( ccWui50 = hucTxArea1 %>% 
    filter(RRK_Region=="Central Coast Region") %>%
    filter(WuiPrct >25& WuiPrct <=50) %>%
    mutate(TxWuiPrctl=50) %>%
    mutate(TxHucNos=109)
  )
```

```{r}
( ccWui75 = hucTxArea1 %>% 
    filter(RRK_Region=="Central Coast Region") %>%
    filter(WuiPrct >50& WuiPrct <=75) %>%
    mutate(TxWuiPrctl=75) %>%
    mutate(TxHucNos=109)
  )
```

```{r}
( ccWui100 = hucTxArea1 %>% 
    filter(RRK_Region=="Central Coast Region") %>%
    filter(WuiPrct >75) %>%
    mutate(TxWuiPrctl=100) %>%
    mutate(TxHucNos=109)
  )
```

## South Coast WUI
```{r}
hucTxArea1 %>% 
    filter(RRK_Region=="South Coast Region")
```

```{r}
( scWui25 = hucTxArea1 %>% 
    filter(RRK_Region=="South Coast Region") %>%
    filter(WuiPrct <=25)%>%
    mutate(TxWuiPrctl=25) %>%
    mutate(TxHucNos=120)
  )
```
(x>=3&x<=7)
```{r}
( scWui50 = hucTxArea1 %>% 
    filter(RRK_Region=="South Coast Region") %>%
    filter(WuiPrct >25& WuiPrct <=50) %>%
    mutate(TxWuiPrctl=50) %>%
    mutate(TxHucNos=120)
  )
```

```{r}
( scWui75 = hucTxArea1 %>% 
    filter(RRK_Region=="South Coast Region") %>%
    filter(WuiPrct >50& WuiPrct <=75) %>%
    mutate(TxWuiPrctl=75) %>%
    mutate(TxHucNos=120)
  )
```

```{r}
( scWui100 = hucTxArea1 %>% 
    filter(RRK_Region=="South Coast Region") %>%
    filter(WuiPrct >75) %>%
    mutate(TxWuiPrctl=100) %>%
    mutate(TxHucNos=120)
  )
```
## Recombine HUCs with added attributes

### Within RRK
```{r}
( snWuiTx = bind_rows(snWui25, snWui50, snWui75, snWui100) )
```

```{r}
( ncWuiTx = bind_rows(ncWui25, ncWui50, ncWui75, ncWui100) )
```

```{r}
( ccWuiTx = bind_rows(ccWui25, ccWui50, ccWui75, ccWui100) )
```

```{r}
( scWuiTx = bind_rows(scWui25, scWui50, scWui75, scWui100) )
```

### All RRKs
```{r}
( allWuiTx = bind_rows(snWuiTx, ncWuiTx, ccWuiTx, scWuiTx) )
```

# BP
## Sierra Nevada BP


```{r}
( snBp25 = snWuiTx %>% 
    filter(BpPrct <=25) %>%
    mutate(TxBpPrctl=25) 
  )
```
(x>=3&x<=7)
```{r}
( snBp50 = snWuiTx %>% 
    filter(BpPrct >25& BpPrct <=50) %>%
    mutate(TxBpPrctl=50) 
  )
```

```{r}
( snBp75 = snWuiTx %>% 
    filter(BpPrct >50& BpPrct <=75)  %>%
    mutate(TxBpPrctl=75) 
  ) 

    
```

```{r}
( snBp100 = snWuiTx %>% 
    filter(BpPrct >75)   %>%
    mutate(TxBpPrctl=100) 
  ) 
    
```

## North Coast BP


```{r}
( ncBp25 = ncWuiTx %>% 
    filter(BpPrct <=25)  %>%
    mutate(TxBpPrctl=25) 
  ) 
    
```
(x>=3&x<=7)
```{r}
( ncBp50 = ncWuiTx %>% 
    filter(BpPrct >25& BpPrct <=50) %>%
    mutate(TxBpPrctl=50) 
  ) 
    
```

```{r}
( ncBp75 = ncWuiTx %>% 
    filter(BpPrct >50& BpPrct <=75) %>%
    mutate(TxBpPrctl=75) 
  ) 
    
```

```{r}
( ncBp100 = ncWuiTx %>% 
    filter(BpPrct >75)  %>%
    mutate(TxBpPrctl=100) 
  ) 
    
```

## Central Coast BP
```{r}
hucTxArea1 %>% 
    filter(RRK_Region=="Central Coast Region")
```

```{r}
( ccBp25 = ccWuiTx %>% 
    filter(BpPrct <=25) %>%
    mutate(TxBpPrctl=25) 
  ) 
```
(x>=3&x<=7)
```{r}
( ccBp50 = ccWuiTx %>% 
    filter(BpPrct >25& BpPrct <=50) %>%
    mutate(TxBpPrctl=50) 
  ) 
```

```{r}
( ccBp75 = ccWuiTx %>% 
    filter(BpPrct >50& BpPrct <=75)  %>%
    mutate(TxBpPrctl=75) 
  ) 
    
```

```{r}
( ccBp100 = ccWuiTx %>% 
    filter(BpPrct >75)  %>%
    mutate(TxBpPrctl=100) 
  ) 
```

## South Coast BP
```{r}
hucTxArea1 %>% 
    filter(RRK_Region=="South Coast Region")
```

```{r}
( scBp25 = scWuiTx %>% 
        filter(BpPrct <=25) %>%
    mutate(TxBpPrctl=25) 
  ) 

```
(x>=3&x<=7)
```{r}
( scBp50 = scWuiTx %>% 
       filter(BpPrct >25& BpPrct <=50) %>%
    mutate(TxBpPrctl=50) 
  ) 
```

```{r}
( scBp75 = scWuiTx %>% 
       filter(BpPrct >50& BpPrct <=75) %>%
    mutate(TxBpPrctl=75) 
  ) 
```

```{r}
( scBp100 = scWuiTx %>% 
       filter(BpPrct >75)  %>%
    mutate(TxBpPrctl=75) 
  ) 
```
# Recombine HUCs with added attributes

## Within RRK
```{r}
( snBpTx = bind_rows(snBp25, snBp50, snBp75, snBp100) )
```

```{r}
( ncBpTx = bind_rows(ncBp25, ncBp50, ncBp75, ncBp100) )
```

```{r}
( ccBpTx = bind_rows(ccBp25, ccBp50, ccBp75, ccBp100) )
```

```{r}
( scBpTx = bind_rows(scBp25, scBp50, scBp75, scBp100) )
```

## All RRKs
```{r}
( allDataTx = bind_rows(snBpTx, ncBpTx, ccBpTx, scBpTx) )
```

```{r}
(
  allDataTx1 = allDataTx %>% 
    mutate(TxSizeSqm = 404686) %>%
    mutate(TxSizeAc = 100) %>%
    mutate(TxRadiiM = (sqrt(TxSizeSqm))/2) %>%
    dplyr::select(huc12:TxBpPrctl,TxArea, TxSizeSqm, TxSizeAc,TxRadiiM,  geometry)
)
```
# Add RFFC
```{r}
allDataTx1 %>% group_by(RRK_Region, Priority) %>%
  summarize(n=n())
```
x > 2 & x < 5,
```{r}
( 
  txRffc = allDataTx1 %>%
  dplyr::mutate(rffc = round(BpPrct*WuiPrct, 2)) %>%
    dplyr::mutate(totCt = as.numeric(ifelse(RRK_Region =="Central Coast Region", 435,
                          ifelse(RRK_Region =="North Coast Region", 774,
                          ifelse(RRK_Region =="Sierra Nevada Region", 1148,
                          ifelse(RRK_Region =="South Coast Region", 480, "NA")))))) %>%
    group_by(RRK_Region) %>%
    mutate(rffcRank= order(order(Priority, rffc))) %>%
    mutate(rffcPrct = round(rffcRank/n() *100, 2)) 
)

```

```{r}
txRffc %>%  filter(RRK_Region=="Central Coast Region") %>%
  dplyr::select(RRK_Region,Priority, rffc, rffcRank, rffcPrct) %>%

  arrange(rffcPrct)
```


```{r}
glimpse(txRffc)
```

```{r}
txRffc %>% filter(RRK_Region=="South Coast Region") %>%
  filter(rffcPrct<=25)
```
```{r}
min(txRffc$Rffc)
max(txRffc$Rffc)
```

```{r}
txRffc %>% group_by(RRK_Region) %>% summarize(across(c(BpRank, BpPrct, WuiRank, WuiPrct, rffcRank, rffcPrct), list(min = min, max = max)))
```

# Add Percentile RFFC



```{r}
( Rffc25 = txRffc %>% 
    filter(rffcPrct <=25) %>%
    mutate(TxRffcPrctl=25) 
  )
```
(x>=3&x<=7)
```{r}
( Rffc50 = txRffc %>% 
    filter(rffcPrct >25& rffcPrct <=50) %>%
    mutate(TxRffcPrctl=50) 
  )
```

```{r}
( Rffc75 = txRffc %>% 
    filter(rffcPrct >50& rffcPrct <=75)  %>%
    mutate(TxRffcPrctl=75) 
  ) 

    
```

```{r}
( Rffc100 = txRffc %>% 
    filter(rffcPrct >75)   %>%
    mutate(TxRffcPrctl=100) 
  ) 
    
```

## Recombine Rows
```{r}
( RffcTx = bind_rows(Rffc25, Rffc50, Rffc75, Rffc100) )
```
```{r}
RffcTx %>%  filter(RRK_Region=="Central Coast Region") %>%
  dplyr::select(RRK_Region,Priority, rffc, rffcRank, rffcPrct, TxRffcPrctl) %>%

  arrange(rffcPrct)
```

## North Coast Rffc


```{r}
( ncRffc25 = nctxRffc %>% 
    filter(rffcPrct <=25)  %>%
    mutate(TxRffcPrctl=25) 
  ) 
    
```
(x>=3&x<=7)
```{r}
( ncRffc50 = nctxRffc %>% 
    filter(rffcPrct >25& rffcPrct <=50) %>%
    mutate(TxRffcPrctl=50) 
  ) 
    
```

```{r}
( ncRffc75 = nctxRffc %>% 
    filter(rffcPrct >50& rffcPrct <=75) %>%
    mutate(TxRffcPrctl=75) 
  ) 
    
```

```{r}
( ncRffc100 = nctxRffc %>% 
    filter(rffcPrct >75)  %>%
    mutate(TxRffcPrctl=100) 
  ) 
    
```

## Central Coast Rffc


```{r}
( ccRffc25 = cctxRffc %>% 
    filter(rffcPrct <=25) %>%
    mutate(TxRffcPrctl=25) 
  ) 
```
(x>=3&x<=7)
```{r}
( ccRffc50 = cctxRffc %>% 
    filter(rffcPrct >25& rffcPrct <=50) %>%
    mutate(TxRffcPrctl=50) 
  ) 
```

```{r}
( ccRffc75 = cctxRffc %>% 
    filter(rffcPrct >50& rffcPrct <=75)  %>%
    mutate(TxRffcPrctl=75) 
  ) 
    
```

```{r}
( ccRffc100 = cctxRffc %>% 
    filter(rffcPrct >75)  %>%
    mutate(TxRffcPrctl=100) 
  ) 
```

## South Coast Rffc


```{r}
( scRffc25 = sctxRffc %>% 
        filter(rffcPrct <=25) %>%
    mutate(TxRffcPrctl=25) 
  ) 

```
(x>=3&x<=7)
```{r}
( scRffc50 = sctxRffc %>% 
       filter(rffcPrct >25& rffcPrct <=50) %>%
    mutate(TxRffcPrctl=50) 
  ) 
```

```{r}
( scRffc75 = sctxRffc %>% 
       filter(rffcPrct >50& rffcPrct <=75) %>%
    mutate(TxRffcPrctl=75) 
  ) 
```

```{r}
( scRffc100 = sctxRffc %>% 
       filter(rffcPrct >75)  %>%
    mutate(TxRffcPrctl=75) 
  ) 
```
## Recombine HUCs with added attributes

### Within RRK
```{r}
( snRffcTx = bind_rows(snRffc25, snRffc50, snRffc75, snRffc100) )
```

```{r}
( ncRffcTx = bind_rows(ncRffc25, ncRffc50, ncRffc75, ncRffc100) )
```

```{r}
( ccRffcTx = bind_rows(ccRffc25, ccRffc50, ccRffc75, ccRffc100) )
```

```{r}
( scRffcTx = bind_rows(scRffc25, scRffc50, scRffc75, scRffc100) )
```

### Recombine RRKs
```{r}
( CombineDataTx = bind_rows(snRffcTx, ncRffcTx, ccRffcTx, scRffcTx) )
```

# Map
```{r}
ggplot(txRffc, aes(group="RRK_Region")) +
  geom_sf(aes(color = rffcPrct))  +
  geom_sf(aes(color = Priorty))
```
```{r}
my_breaks <- c(25, 50, 75, 100)
ggplot(txRffc) +
    geom_sf(aes(fill = rffcPrct), lwd = 0)+
    scale_fill_gradientn(colours=rev(magma(4)),
                         name="RFFC Rank Percent",
                         na.value = "grey100", 
                         breaks = my_breaks, labels = my_breaks)
```
without_boundary <-
  ggplot() +
    geom_sf(data = world1, mapping = aes(fill = ID), lwd = 0) +
  theme(legend.position = "none") +
  ggtitle("Without Country Boundaries")
# Write to shapefile
```{r eval=FALSE, include=FALSE}
st_write(allDataTx1, "../outputs/hucsShp/TxPrctRankRrkWip.shp", driver="ESRI Shapefile")
```

# Write to shapefile
```{r eval=FALSE, include=FALSE}
st_write(txRffc , "../outputs/hucsShp/TxPrctRankRrkWipRffc.shp", driver="ESRI Shapefile")
```